<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Caixa e Gastos (Híbrido)</title>
    <!-- Carrega o Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a biblioteca Chart.js para criar os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Carrega a fonte Inter do Google Fonts para um visual moderno -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 1200px; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .remove-btn { background-color: #ef4444; color: white; border-radius: 0.375rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; line-height: 1; transition: background-color 0.2s; flex-shrink: 0; }
        .remove-btn:hover { background-color: #dc2626; }
        .tab-button.active { background-color: #4f46e5; color: white; font-weight: 600; }
        .month-content { display: none; }
        .month-content.active { display: block; }
        .modal-overlay { transition: opacity 0.2s ease-in-out; }
        .modal-content { transition: transform 0.2s ease-in-out; }
    </style>
</head>
<body class="p-2 sm:p-4">
    <!-- Bloco de dados JSON para a versão portátil. NÃO REMOVA OU EDITE ESTA LINHA. -->
    <script id="data-storage" type="application/json"></script>

    <!-- Modal para Gerenciar Cartões -->
    <div id="cards-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Gerenciar Cartões de Crédito</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-card-name" placeholder="Nome do Cartão (ex: Nubank)" class="flex-grow p-2 border border-gray-300 rounded-md">
                <button id="add-card-btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Adicionar</button>
            </div>
            <div id="card-list" class="flex flex-col gap-2">
                <!-- Lista de cartões será inserida aqui -->
            </div>
            <div class="text-right mt-6">
                <button id="close-modal-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Fechar</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto bg-white p-4 md:p-6 rounded-lg shadow-xl relative">
        <!-- Informações de Versão -->
        <div class="absolute top-4 left-4 text-xs text-gray-400">
            <div>ver 1.0</div>
            <div>Franzoi Tech</div>
        </div>

        <div class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mt-8">Controle de Caixa e Gastos Mensais</h1>
            <p class="text-sm text-gray-500 mt-2">As alterações são salvas automaticamente no navegador.</p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-2 sm:gap-4 mt-4">
                 <button id="manage-cards-btn" class="w-full sm:w-auto px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors">
                    Gerenciar Cartões
                </button>
                <button id="save-and-download-btn" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                    Criar Versão Portátil (Download)
                </button>
            </div>
        </div>

        <div class="flex justify-center flex-wrap gap-2 mb-6" id="monthTabs"></div>
        <div id="monthContentContainer"></div>

        <!-- Seção de Rodapé com Disclaimer e PIX -->
        <div class="mt-12 pt-6 border-t border-gray-200 text-center text-gray-500">
            <p class="italic text-sm">Esta planilha é Freeware, não aceite pagar por ela.</p>
            <p class="italic text-sm mt-2">Caso tenha ajudado, doe qualquer valor para o Pix abaixo.</p>
            <div class="mt-4 flex justify-center">
                <iframe src="https://drive.google.com/file/d/1s8uZhOj-lo84fpnA5Hyjz_CIEMhO80Fz/preview" width="150" height="150" allow="autoplay" style="border:0;"></iframe>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const monthTabsContainer = document.getElementById('monthTabs');
            const monthContentContainer = document.getElementById('monthContentContainer');
            const saveAndDownloadBtn = document.getElementById('save-and-download-btn');
            const manageCardsBtn = document.getElementById('manage-cards-btn');
            const cardsModal = document.getElementById('cards-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const addCardBtn = document.getElementById('add-card-btn');
            const newCardNameInput = document.getElementById('new-card-name');
            const cardListContainer = document.getElementById('card-list');

            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro", "Balanço Anual"];
            const basePaymentMethods = ['Pix', 'Débito', 'Crédito', 'Dinheiro', 'Outro'];
            let creditCards = [];
            let monthlyData = {};
            let activeMonthIndex = 0;
            let chartInstances = {};

            const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;
            
            const saveDataToLocalStorage = () => {
                localStorage.setItem('monthlyExpenseData', JSON.stringify(monthlyData));
                localStorage.setItem('creditCardsData', JSON.stringify(creditCards));
            };

            const downloadPortableFile = () => {
                const dataToSave = JSON.stringify(monthlyData, null, 2);
                const docClone = document.cloneNode(true);
                const dataScript = docClone.getElementById('data-storage');
                if (dataScript) dataScript.textContent = dataToSave;
                
                const head = docClone.querySelector('head');
                const cardsScript = document.createElement('script');
                cardsScript.id = 'cards-data-storage';
                cardsScript.type = 'application/json';
                cardsScript.textContent = JSON.stringify(creditCards);
                head.appendChild(cardsScript);

                const fullHtml = `<!DOCTYPE html>\n` + docClone.documentElement.outerHTML;
                const blob = new Blob([fullHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'controle_financeiro_portatil.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert("Versão portátil gerada! Salve o arquivo para levá-lo com você.");
            };

            const loadData = () => {
                const embeddedDataContainer = document.getElementById('data-storage');
                const embeddedCardsContainer = document.getElementById('cards-data-storage');
                const localStorageData = localStorage.getItem('monthlyExpenseData');
                const localStorageCards = localStorage.getItem('creditCardsData');
                let dataToLoad = null;

                if (embeddedCardsContainer) {
                    creditCards = JSON.parse(embeddedCardsContainer.textContent);
                    localStorage.setItem('creditCardsData', JSON.stringify(creditCards));
                } else if (localStorageCards) {
                    creditCards = JSON.parse(localStorageCards);
                }

                if (embeddedDataContainer && embeddedDataContainer.textContent.trim().length > 0) {
                    dataToLoad = JSON.parse(embeddedDataContainer.textContent);
                    localStorage.setItem('monthlyExpenseData', JSON.stringify(dataToLoad));
                } 
                else if (localStorageData) {
                    dataToLoad = JSON.parse(localStorageData);
                }

                for (let i = 0; i < 12; i++) {
                    const monthData = dataToLoad ? dataToLoad[i] : null;
                    monthlyData[i] = monthData || { 
                        companyCash: 0, 
                        pjEntries: [], 
                        pfEntries: [], 
                        expenses: Array(31).fill(null).map(() => ({ personalEntries: [], businessEntries: [] })) 
                    };
                    monthlyData[i].pfEntries = monthlyData[i].pfEntries || [];
                    monthlyData[i].expenses.forEach(day => {
                        day.personalEntries.forEach(entry => {
                            entry.paymentMethod = entry.paymentMethod || 'Pix';
                            entry.card = entry.card || (creditCards.length > 0 ? creditCards[0] : '');
                        });
                        day.businessEntries.forEach(entry => {
                            entry.paymentMethod = entry.paymentMethod || 'Pix';
                            entry.card = entry.card || (creditCards.length > 0 ? creditCards[0] : '');
                        });
                    });
                }
            };
            
            const createMonthContentHTML = (monthIndex) => `
                <div id="month-${monthIndex}-content" class="month-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-yellow-50 p-4 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold text-gray-800 mb-3">Ganhos PJ (R$)</h2>
                            <div id="pj-entries-container-${monthIndex}" class="flex flex-col gap-2 mb-2"></div>
                            <button class="add-entry-btn mt-2 w-full px-3 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 text-sm font-medium" data-month-index="${monthIndex}" data-type="pj">+ Adicionar Ganho PJ</button>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold text-gray-800 mb-3">Ganhos PF (R$)</h2>
                            <div id="pf-entries-container-${monthIndex}" class="flex flex-col gap-2 mb-2"></div>
                            <button class="add-entry-btn mt-2 w-full px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm font-medium" data-month-index="${monthIndex}" data-type="pf">+ Adicionar Ganho PF</button>
                        </div>
                        <div class="grid gap-6">
                            <div class="bg-blue-50 p-4 rounded-lg shadow-md">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Caixa da empresa (R$):</label>
                                <input type="text" id="companyCash-${monthIndex}" value="${formatCurrency(0)}" readonly class="w-full p-3 border border-blue-300 rounded-md text-lg font-semibold text-blue-700 bg-gray-100 shadow-sm cursor-not-allowed">
                                <label class="block text-sm font-medium text-gray-700 mt-2 mb-2">Caixa pessoal (R$):</label>
                                <input type="text" id="personalCash-${monthIndex}" value="${formatCurrency(0)}" readonly class="w-full p-3 border border-blue-300 rounded-md text-lg font-semibold text-blue-700 bg-gray-100 shadow-sm cursor-not-allowed">
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg shadow-md">
                                <h2 class="text-xl font-semibold text-gray-800 mb-3">Resumo dos Gastos</h2>
                                <div class="flex justify-between items-center mb-2"><span class="text-gray-600">Total Pessoal:</span><span id="totalPersonal-${monthIndex}" class="text-lg font-bold text-red-600">R$ 0,00</span></div>
                                <div class="flex justify-between items-center mb-2"><span class="text-gray-600">Total Empresa:</span><span id="totalBusiness-${monthIndex}" class="text-lg font-bold text-green-600">R$ 0,00</span></div>
                                <div class="flex justify-between items-center border-t pt-2 mt-2"><span class="font-medium">Total Geral:</span><span id="totalOverall-${monthIndex}" class="text-xl font-bold text-gray-800">R$ 0,00</span></div>
                                <div class="flex justify-between items-center border-t pt-2 mt-2"><span class="font-medium">Saldo Restante:</span><span id="remainingBudget-${monthIndex}" class="text-xl font-bold text-blue-700">R$ 0,00</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto mb-8">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead><tr class="bg-gray-100 text-gray-600 uppercase text-sm"><th class="py-3 px-6 text-left rounded-tl-lg">Dia</th><th class="py-3 px-6 text-left">Gastos Pessoais</th><th class="py-3 px-6 text-left rounded-tr-lg">Gastos da Empresa</th></tr></thead>
                            <tbody id="expenseTableBody-${monthIndex}" class="text-gray-700 text-sm font-light"></tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-lg shadow-xl">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Balanço do Mês</h2>
                            <div class="relative mx-auto" style="max-width: 400px; height: 400px;"><canvas id="budgetPieChart-${monthIndex}"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-xl">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Gastos por Forma de Pagamento</h2>
                            <div class="relative mx-auto" style="max-width: 400px; height: 400px;"><canvas id="paymentMethodChart-${monthIndex}"></canvas></div>
                        </div>
                    </div>
                </div>`;

            const createBalanceContentHTML = () => `
                <div id="month-${monthNames.length - 1}-content" class="month-content">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Balanço Anual</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8 text-center">
                        <div class="bg-yellow-50 p-4 rounded-lg shadow-md"><span class="block text-sm font-medium text-gray-700 mb-2">Total Ganhos PJ:</span><span id="totalAnnualPJ" class="text-xl font-bold text-yellow-700">R$ 0,00</span></div>
                        <div class="bg-green-50 p-4 rounded-lg shadow-md"><span class="block text-sm font-medium text-gray-700 mb-2">Total Ganhos PF:</span><span id="totalAnnualPF" class="text-xl font-bold text-green-700">R$ 0,00</span></div>
                        <div class="bg-purple-50 p-4 rounded-lg shadow-md"><span class="block text-sm font-medium text-gray-700 mb-2">Gastos Totais Anuais:</span><span id="totalAnnualExpenses" class="text-xl font-bold text-red-600">R$ 0,00</span></div>
                        <div class="bg-blue-50 p-4 rounded-lg shadow-md"><span class="block text-sm font-medium text-gray-700 mb-2">Saldo Anual:</span><span id="annualBalance" class="text-xl font-bold text-blue-800">R$ 0,00</span><p id="annualPerformance" class="text-lg font-semibold mt-2"></p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-xl lg:col-span-2"><h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Desempenho Mensal Detalhado</h3><div class="relative mx-auto" style="height: 400px;"><canvas id="monthlyPerformanceBarChart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-lg shadow-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Distribuição Anual de Gastos</h3><div class="relative mx-auto" style="max-width: 400px; height: 400px;"><canvas id="annualExpenseDistributionPieChart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-lg shadow-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Gastos Anuais por Forma de Pagamento</h3><div class="relative mx-auto" style="max-width: 400px; height: 400px;"><canvas id="annualPaymentMethodChart"></canvas></div></div>
                    </div>
                </div>`;

            const renderTabs = () => {
                monthTabsContainer.innerHTML = monthNames.map((month, index) =>
                    `<button class="tab-button px-4 py-2 rounded-md text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors ${index === activeMonthIndex ? 'active' : ''}" data-month-index="${index}">${month}</button>`
                ).join('');
            };

            const showMonth = (monthIndex) => {
                activeMonthIndex = monthIndex;
                Object.values(chartInstances).forEach(chart => chart?.destroy());
                renderTabs();
                document.querySelectorAll('.month-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`month-${monthIndex}-content`).classList.add('active');

                if (monthIndex === monthNames.length - 1) {
                    renderBalanceSummary();
                } else {
                    renderPJEntries(monthIndex);
                    renderPFEntries(monthIndex);
                    renderExpenseTable(monthIndex);
                    recalculateAndDisplayTotals(monthIndex);
                }
            };

            const createEntryElement = (config) => {
                const { monthIndex, dayIndex, category, entry, type } = config;
                const entryDiv = document.createElement('div');
                entryDiv.classList.add('flex', 'items-center', 'gap-2', 'w-full', 'flex-wrap');
                
                let colorClasses = 'border-gray-300';
                if (type === 'expense') {
                    colorClasses = category === 'personal' ? 'border-red-300 text-red-700' : 'border-green-300 text-green-700';
                } else if (type === 'pj' || type === 'pf') {
                    colorClasses = 'border-green-300 text-green-700';
                }
                
                let removeBtnHTML = '';
                let paymentMethodHTML = '';
                let cardSelectorHTML = '';

                if (type === 'expense') {
                    removeBtnHTML = `<button class="remove-btn" data-type="expense" data-month-index="${monthIndex}" data-day="${dayIndex}" data-category="${category}" data-entry-id="${entry.id}">X</button>`;
                    const paymentOptions = basePaymentMethods.map(method => `<option value="${method}" ${entry.paymentMethod === method ? 'selected' : ''}>${method}</option>`).join('');
                    paymentMethodHTML = `<select class="entry-input p-2 border border-gray-300 rounded-md text-sm w-full sm:w-auto" data-field="paymentMethod">${paymentOptions}</select>`;
                    
                    if (entry.paymentMethod === 'Crédito') {
                        const cardOptions = creditCards.map(card => `<option value="${card}" ${entry.card === card ? 'selected' : ''}>${card}</option>`).join('');
                        cardSelectorHTML = `<select class="entry-input p-2 border border-gray-300 rounded-md text-sm w-full sm:w-auto" data-field="card">${cardOptions}</select>`;
                    }
                } else { // É uma entrada PJ ou PF
                    removeBtnHTML = `<button class="remove-btn" data-type="${type}" data-month-index="${monthIndex}" data-entry-id="${entry.id}">X</button>`;
                }

                entryDiv.innerHTML = `
                    <input type="text" value="${entry.description}" placeholder="Descrição" class="entry-input flex-grow p-2 border border-gray-300 rounded-md text-sm" data-field="description">
                    <input type="number" value="${entry.amount}" min="0" step="0.01" placeholder="0.00" class="entry-input w-24 p-2 border rounded-md text-sm ${colorClasses}" data-field="amount">
                    ${paymentMethodHTML}
                    <span class="card-selector-container">${cardSelectorHTML}</span>
                    ${removeBtnHTML}
                `;
                return entryDiv;
            };

            const renderPJEntries = (monthIndex) => {
                const container = document.getElementById(`pj-entries-container-${monthIndex}`);
                if (!container) return;
                container.innerHTML = '';
                monthlyData[monthIndex].pjEntries.forEach(entry => {
                    container.appendChild(createEntryElement({ monthIndex, entry, type: 'pj' }));
                });
            };

            const renderPFEntries = (monthIndex) => {
                const container = document.getElementById(`pf-entries-container-${monthIndex}`);
                if (!container) return;
                container.innerHTML = '';
                monthlyData[monthIndex].pfEntries.forEach(entry => {
                    container.appendChild(createEntryElement({ monthIndex, entry, type: 'pf' }));
                });
            };

            const renderExpenseTable = (monthIndex) => {
                const tableBody = document.getElementById(`expenseTableBody-${monthIndex}`);
                if (!tableBody) return;
                tableBody.innerHTML = '';
                for (let day = 0; day < 31; day++) {
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-50');
                    if ((day + 1) % 2 === 0) row.classList.add('bg-gray-50');
                    
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap font-medium text-gray-900 align-top">${day + 1}</td>
                        <td class="py-3 px-6 text-left align-top"><div id="personal-entries-${monthIndex}-${day}" class="flex flex-col gap-2"></div><button class="add-entry-btn mt-2 px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-xs" data-month-index="${monthIndex}" data-day="${day}" data-type="expense" data-category="personal">+ Gasto Pessoal</button></td>
                        <td class="py-3 px-6 text-left align-top"><div id="business-entries-${monthIndex}-${day}" class="flex flex-col gap-2"></div><button class="add-entry-btn mt-2 px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 text-xs" data-month-index="${monthIndex}" data-day="${day}" data-type="expense" data-category="business">+ Gasto Empresa</button></td>
                    `;
                    tableBody.appendChild(row);

                    ['personal', 'business'].forEach(category => {
                        const container = document.getElementById(`${category}-entries-${monthIndex}-${day}`);
                        const entries = monthlyData[monthIndex].expenses[day][`${category}Entries`];
                        entries.forEach(entry => {
                            container.appendChild(createEntryElement({ monthIndex, dayIndex: day, category, entry, type: 'expense' }));
                        });
                    });
                }
            };

            const recalculateAndDisplayTotals = (monthIndex) => {
                const data = monthlyData[monthIndex];
                const totalPJ = data.pjEntries.reduce((sum, entry) => sum + entry.amount, 0);
                const totalPF = data.pfEntries.reduce((sum, entry) => sum + entry.amount, 0);
                const totalCash = totalPJ + totalPF;
                
                const totalPersonal = data.expenses.flat().reduce((acc, day) => acc + day.personalEntries.reduce((sum, entry) => sum + entry.amount, 0), 0);
                const totalBusiness = data.expenses.flat().reduce((acc, day) => acc + day.businessEntries.reduce((sum, entry) => sum + entry.amount, 0), 0);
                const totalOverall = totalPersonal + totalBusiness;
                const remainingBudget = totalCash - totalOverall;

                document.getElementById(`companyCash-${monthIndex}`).value = formatCurrency(totalPJ);
                document.getElementById(`personalCash-${monthIndex}`).value = formatCurrency(totalPF);
                document.getElementById(`totalPersonal-${monthIndex}`).textContent = formatCurrency(totalPersonal);
                document.getElementById(`totalBusiness-${monthIndex}`).textContent = formatCurrency(totalBusiness);
                document.getElementById(`totalOverall-${monthIndex}`).textContent = formatCurrency(totalOverall);
                const remainingEl = document.getElementById(`remainingBudget-${monthIndex}`);
                remainingEl.textContent = formatCurrency(remainingBudget);
                remainingEl.classList.toggle('text-red-600', remainingBudget < 0);
                remainingEl.classList.toggle('text-blue-700', remainingBudget >= 0);

                updatePieChart(monthIndex, totalPersonal, totalBusiness, remainingBudget);
                updatePaymentMethodChart(monthIndex);
            };
            
            const updatePieChart = (monthIndex, personal, business, remaining) => {
                const ctx = document.getElementById(`budgetPieChart-${monthIndex}`).getContext('2d');
                if (chartInstances.pie) chartInstances.pie.destroy();
                chartInstances.pie = new Chart(ctx, {
                    type: 'pie',
                    data: { labels: ['Gastos Pessoais', 'Gastos da Empresa', 'Saldo Restante'], datasets: [{ data: [personal, business, Math.max(0, remaining)], backgroundColor: ['#ef4444', '#22c55e', '#3b82f6'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.parsed)}` } } } }
                });
            };

            const updatePaymentMethodChart = (monthIndex) => {
                const dynamicLabels = [...basePaymentMethods.filter(m => m !== 'Crédito'), ...creditCards.map(c => `Crédito (${c})`)];
                const totalsByMethod = Object.fromEntries(dynamicLabels.map(label => [label, 0]));
                
                monthlyData[monthIndex].expenses.forEach(day => {
                    [...day.personalEntries, ...day.businessEntries].forEach(entry => {
                        let key = entry.paymentMethod;
                        if (key === 'Crédito') {
                            key = `Crédito (${entry.card})`;
                        }
                        if (totalsByMethod[key] !== undefined) {
                           totalsByMethod[key] += entry.amount;
                        }
                    });
                });

                const ctx = document.getElementById(`paymentMethodChart-${monthIndex}`).getContext('2d');
                if (chartInstances.payment) chartInstances.payment.destroy();
                chartInstances.payment = new Chart(ctx, {
                    type: 'doughnut',
                    data: { 
                        labels: dynamicLabels, 
                        datasets: [{ 
                            data: Object.values(totalsByMethod),
                            backgroundColor: ['#38bdf8', '#34d399', '#facc15', '#a78bfa', '#f87171', '#fb923c', '#db2777', '#6d28d9']
                        }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.parsed)}` } } } }
                });
            };

            const renderBalanceSummary = () => {
                let totalPJ = 0, totalPF = 0, totalPersonal = 0, totalBusiness = 0;
                const monthlyPjGains = [], monthlyPfGains = [], monthlyPersonalExpenses = [], monthlyBusinessExpenses = [];
                
                const dynamicLabels = [...basePaymentMethods.filter(m => m !== 'Crédito'), ...creditCards.map(c => `Crédito (${c})`)];
                const annualTotalsByMethod = Object.fromEntries(dynamicLabels.map(label => [label, 0]));

                for (let i = 0; i < 12; i++) {
                    const data = monthlyData[i];
                    const monthPJ = data.pjEntries.reduce((sum, entry) => sum + entry.amount, 0);
                    const monthPF = data.pfEntries.reduce((sum, entry) => sum + entry.amount, 0);
                    totalPJ += monthPJ;
                    totalPF += monthPF;
                    monthlyPjGains.push(monthPJ);
                    monthlyPfGains.push(monthPF);
                    
                    let monthPersonal = 0, monthBusiness = 0;
                    data.expenses.forEach(day => {
                        day.personalEntries.forEach(entry => {
                            monthPersonal += entry.amount;
                            let key = entry.paymentMethod === 'Crédito' ? `Crédito (${entry.card})` : entry.paymentMethod;
                            if (annualTotalsByMethod[key] !== undefined) annualTotalsByMethod[key] += entry.amount;
                        });
                        day.businessEntries.forEach(entry => {
                            monthBusiness += entry.amount;
                            let key = entry.paymentMethod === 'Crédito' ? `Crédito (${entry.card})` : entry.paymentMethod;
                            if (annualTotalsByMethod[key] !== undefined) annualTotalsByMethod[key] += entry.amount;
                        });
                    });
                    totalPersonal += monthPersonal;
                    totalBusiness += monthBusiness;
                    monthlyPersonalExpenses.push(monthPersonal);
                    monthlyBusinessExpenses.push(monthBusiness);
                }
                const totalExpenses = totalPersonal + totalBusiness;
                const balance = (totalPJ + totalPF) - totalExpenses;

                document.getElementById('totalAnnualPJ').textContent = formatCurrency(totalPJ);
                document.getElementById('totalAnnualPF').textContent = formatCurrency(totalPF);
                document.getElementById('totalAnnualExpenses').textContent = formatCurrency(totalExpenses);
                document.getElementById('annualBalance').textContent = formatCurrency(balance);
                const perfEl = document.getElementById('annualPerformance');
                perfEl.textContent = balance >= 0 ? 'POSITIVO!' : 'NEGATIVO!';
                perfEl.className = `text-lg font-semibold mt-2 ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
                updateAnnualCharts(totalPersonal, totalBusiness, monthlyPjGains, monthlyPfGains, monthlyPersonalExpenses, monthlyBusinessExpenses, annualTotalsByMethod);
            };

            const updateAnnualCharts = (personal, business, pjGains, pfGains, personalExpenses, businessExpenses, totalsByMethod) => {
                const barCtx = document.getElementById('monthlyPerformanceBarChart').getContext('2d');
                chartInstances.bar = new Chart(barCtx, {
                    type: 'bar',
                    data: { 
                        labels: monthNames.slice(0, 12), 
                        datasets: [
                            { label: 'Caixa Gerado (PJ)', data: pjGains, backgroundColor: '#1e3a8a' }, 
                            { label: 'Caixa Gerado (PF)', data: pfGains, backgroundColor: '#16a34a' }, 
                            { label: 'Gasto Pessoal', data: personalExpenses, backgroundColor: '#ca8a04' },
                            { label: 'Gasto Empresa', data: businessExpenses, backgroundColor: '#dc2626' }
                        ] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: v => formatCurrency(v) } } }, plugins: { tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.parsed.y)}` } } } }
                });

                const pieCtx = document.getElementById('annualExpenseDistributionPieChart').getContext('2d');
                chartInstances.annualPie = new Chart(pieCtx, {
                    type: 'pie',
                    data: { labels: ['Gastos Pessoais Anuais', 'Gastos da Empresa Anuais'], datasets: [{ data: [personal, business], backgroundColor: ['#ca8a04', '#dc2626'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.parsed)}` } } } }
                });

                const paymentCtx = document.getElementById('annualPaymentMethodChart').getContext('2d');
                chartInstances.annualPayment = new Chart(paymentCtx, {
                    type: 'doughnut',
                    data: { 
                        labels: Object.keys(totalsByMethod), 
                        datasets: [{ 
                            data: Object.values(totalsByMethod),
                            backgroundColor: ['#38bdf8', '#34d399', '#facc15', '#a78bfa', '#f87171', '#fb923c', '#db2777', '#6d28d9']
                        }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.parsed)}` } } } }
                });
            };

            const renderCardList = () => {
                cardListContainer.innerHTML = '';
                creditCards.forEach(card => {
                    const cardDiv = document.createElement('div');
                    cardDiv.classList.add('flex', 'items-center', 'justify-between', 'p-2', 'bg-gray-100', 'rounded-md');
                    cardDiv.innerHTML = `
                        <span>${card}</span>
                        <button class="remove-card-btn text-red-500 hover:text-red-700 font-bold" data-card-name="${card}">X</button>
                    `;
                    cardListContainer.appendChild(cardDiv);
                });
            };

            // INICIALIZAÇÃO E EVENTOS
            const initializeApp = () => {
                loadData();
                monthNames.forEach((_, index) => {
                    monthContentContainer.insertAdjacentHTML('beforeend', index === monthNames.length - 1 ? createBalanceContentHTML() : createMonthContentHTML(index));
                });
                showMonth(activeMonthIndex);
                
                document.body.addEventListener('click', (event) => {
                    const target = event.target;
                    
                    if (target.matches('.tab-button')) {
                        showMonth(parseInt(target.dataset.monthIndex));
                    }

                    if (target.matches('.add-entry-btn')) {
                        const { monthIndex, type, day, category } = target.dataset;
                        const month = parseInt(monthIndex);
                        
                        if (type === 'pj') {
                            monthlyData[month].pjEntries.push({ id: Date.now(), description: '', amount: 0 });
                            renderPJEntries(month);
                        } else if (type === 'pf') {
                            monthlyData[month].pfEntries.push({ id: Date.now(), description: '', amount: 0 });
                            renderPFEntries(month);
                        } else if (type === 'expense') {
                            const dayIndex = parseInt(day);
                            monthlyData[month].expenses[dayIndex][`${category}Entries`].push({ id: Date.now(), description: '', amount: 0, paymentMethod: 'Pix', card: creditCards.length > 0 ? creditCards[0] : '' });
                            renderExpenseTable(month);
                        }
                        recalculateAndDisplayTotals(month);
                        saveDataToLocalStorage();
                    }

                    if (target.matches('.remove-btn')) {
                        const { monthIndex, type, day, category, entryId } = target.dataset;
                        const month = parseInt(monthIndex);
                        const id = parseFloat(entryId);

                        if (type === 'pj') {
                            monthlyData[month].pjEntries = monthlyData[month].pjEntries.filter(e => e.id !== id);
                            renderPJEntries(month);
                        } else if (type === 'pf') {
                            monthlyData[month].pfEntries = monthlyData[month].pfEntries.filter(e => e.id !== id);
                            renderPFEntries(month);
                        } else if (type === 'expense') {
                            const dayIndex = parseInt(day);
                            const entries = monthlyData[month].expenses[dayIndex][`${category}Entries`];
                            monthlyData[month].expenses[dayIndex][`${category}Entries`] = entries.filter(e => e.id !== id);
                            renderExpenseTable(month);
                        }
                        recalculateAndDisplayTotals(month);
                        saveDataToLocalStorage();
                    }

                    if (target.matches('.remove-card-btn')) {
                        const cardNameToRemove = target.dataset.cardName;
                        creditCards = creditCards.filter(c => c !== cardNameToRemove);
                        renderCardList();
                        saveDataToLocalStorage();
                    }
                });

                document.body.addEventListener('input', (event) => {
                    const target = event.target;
                    if (target.matches('.entry-input')) {
                        const entryElement = target.closest('.flex');
                        const removeBtn = entryElement.querySelector('.remove-btn');
                        if (!removeBtn) return;

                        const { monthIndex, type, day, category, entryId } = removeBtn.dataset;
                        const month = parseInt(monthIndex);
                        const id = parseFloat(entryId);

                        let entryToUpdate;
                        if (type === 'pj') {
                            entryToUpdate = monthlyData[month].pjEntries.find(e => e.id === id);
                        } else if (type === 'pf') {
                            entryToUpdate = monthlyData[month].pfEntries.find(e => e.id === id);
                        } else {
                            const dayIndex = parseInt(day);
                            entryToUpdate = monthlyData[month].expenses[dayIndex][`${category}Entries`].find(e => e.id === id);
                        }

                        if (entryToUpdate) {
                            const field = target.dataset.field;
                            if (field === 'description') entryToUpdate.description = target.value;
                            else if (field === 'amount') entryToUpdate.amount = parseFloat(target.value) || 0;
                            else if (field === 'paymentMethod') {
                                entryToUpdate.paymentMethod = target.value;
                                renderExpenseTable(month); // Re-renderiza para mostrar/esconder o seletor de cartão
                            }
                            else if (field === 'card') entryToUpdate.card = target.value;
                            
                            recalculateAndDisplayTotals(month);
                            saveDataToLocalStorage();
                        }
                    }
                });

                manageCardsBtn.addEventListener('click', () => {
                    renderCardList();
                    cardsModal.classList.remove('hidden');
                    setTimeout(() => cardsModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
                });
                closeModalBtn.addEventListener('click', () => {
                    cardsModal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => cardsModal.classList.add('hidden'), 200);
                });
                addCardBtn.addEventListener('click', () => {
                    const newCard = newCardNameInput.value.trim();
                    if (newCard && !creditCards.includes(newCard)) {
                        creditCards.push(newCard);
                        newCardNameInput.value = '';
                        renderCardList();
                        saveDataToLocalStorage();
                    }
                });
                saveAndDownloadBtn.addEventListener('click', downloadPortableFile);
            };

            initializeApp();
        });
    </script>
</body>
</html>
